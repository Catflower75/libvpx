name: Prebuild libvpx (VS2019 v142, x86-windows-static, /MT)

on:
  workflow_dispatch:

jobs:
  libvpx-x86:
    runs-on: windows-2022
    env:
      VCPKG_PLATFORM_TOOLSET: v142   # force VS2019 toolset
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure v142 toolset (install if missing)
        shell: pwsh
        run: |
          $vsInstaller = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vs_installer.exe"
          $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
          $hasV142 = & $vswhere -products * -requires Microsoft.VisualStudio.Component.VC.v142.x86.x64 -property installationPath
          if (-not $hasV142) {
            Write-Host "Installing VS2019 v142 toolset..."
            $vsPath = & $vswhere -products * -latest -property installationPath
            & $vsInstaller modify --installPath "$vsPath" --add Microsoft.VisualStudio.Component.VC.v142.x86.x64 --quiet --norestart --nocache
            if ($LASTEXITCODE -ne 0) { throw "Failed to install v142 toolset." }
          }
          "v142 is available."

      - name: Clone vcpkg
        run: git clone --depth 1 https://github.com/microsoft/vcpkg.git

      - name: Bootstrap vcpkg
        run: .\vcpkg\bootstrap-vcpkg.bat -disableMetrics

      - name: Install libvpx (x86-windows-static, /MT)
        run: .\vcpkg\vcpkg.exe install libvpx:x86-windows-static --clean-after-build

      - name: Show vcpkg state
        shell: pwsh
        run: |
          .\vcpkg\vcpkg.exe list
          Write-Host "Listing installed directories:"
          Get-ChildItem -Recurse -Directory .\vcpkg\installed | Select-Object FullName
          Write-Host "Listing lib directories:"
          Get-ChildItem -Recurse -Directory .\vcpkg\installed\x86-windows-static\lib -ErrorAction SilentlyContinue | Select-Object FullName

      - name: Collect library
        shell: pwsh
        run: |
          $vcpkgRoot = Resolve-Path ".\vcpkg"
          $libDir = Join-Path $vcpkgRoot "installed\x86-windows-static\lib"
          if (!(Test-Path $libDir)) {
            $dbgDir = Join-Path $vcpkgRoot "installed\x86-windows-static\debug\lib"
            if (!(Test-Path $dbgDir)) {
              throw "vcpkg lib folder not found. Checked:`n$libDir`n$dbgDir"
            }
            $libDir = $dbgDir
          }
          New-Item -ItemType Directory -Force -Path artifacts\x86-windows-static | Out-Null
          $lib = Get-ChildItem -Filter "vpx*.lib" $libDir | Select-Object -First 1
          if (-not $lib) { throw "vpx*.lib not found in $libDir" }
          Copy-Item $lib.FullName "artifacts\x86-windows-static\vpx.lib"
          Copy-Item $lib.FullName "artifacts\x86-windows-static\vpxmt.lib"

      - name: Locate dumpbin (optional)
        shell: pwsh
        run: |
          $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
          $vsPath = & $vswhere -products * -latest -property installationPath
          if ($vsPath) {
            $patterns = @(
              Join-Path $vsPath "VC\Tools\MSVC\*\bin\Hostx64\x86\dumpbin.exe"
              Join-Path $vsPath "VC\Tools\MSVC\*\bin\Hostx64\x64\dumpbin.exe"
              Join-Path $vsPath "VC\Tools\MSVC\*\bin\Hostx86\x86\dumpbin.exe"
            )
            $dumpbin = Get-ChildItem -Path $patterns -ErrorAction SilentlyContinue | Sort-Object FullName -Descending | Select-Object -First 1
            if ($dumpbin) {
              "DUMPBIN=$($dumpbin.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append
              Write-Host "Found dumpbin at $($dumpbin.FullName)"
            } else {
              "NO_DUMPBIN=1" | Out-File -FilePath $env:GITHUB_ENV -Append
              Write-Warning "dumpbin.exe not found; CRT verification will be skipped."
            }
          } else {
            "NO_DUMPBIN=1" | Out-File -FilePath $env:GITHUB_ENV -Append
            Write-Warning "vswhere did not return a VS installation; CRT verification will be skipped."
          }

      - name: Verify static CRT (/MT) if dumpbin is available
        shell: pwsh
        run: |
          if (!(Test-Path "artifacts\x86-windows-static\vpx.lib")) {
            Write-Warning "Release lib not present; skipping CRT verification."
            exit 0
          }
          if ($env:NO_DUMPBIN -eq "1" -or -not (Test-Path $env:DUMPBIN)) {
            Write-Warning "dumpbin not available; skipping CRT verification."
            exit 0
          }
          $out = & "$env:DUMPBIN" /directives "artifacts\x86-windows-static\vpx.lib"
          $out | Out-File -FilePath artifacts\x86-windows-static\dumpbin-directives.txt -Encoding ascii
          if ($out -notmatch "LIBCMT") { Write-Host $out; throw "Library is not linked with static CRT (expected LIBCMT)." }
          "Verified: static CRT (LIBCMT) detected."

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libvpx-v142-x86-windows-static
          path: artifacts/x86-windows-static/*
